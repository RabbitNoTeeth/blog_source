---
title: 在vertx中使用虚拟线程
description: 在vertx中使用虚拟线程, 虚拟线程
lang: zh-CN
---

在vert.x的使用中，我使用最多的是用vert.x来构建http服务，对于绝大多数web应用而言，数据库操作是必不可少的，而数据库操作是阻塞式的。

vert.x官方重点说明了一条黄金法则：`The Golden Rule - Don’t Block the Event Loop`，也就是不要阻塞 event loop。对于http请求的处理，默认是在 event loop 中，如果请求中需要进行比较耗时的数据库操作，那么最好是将这个操作通过其他线程处理。 vert.x提供了 `Vertx.executeBlocking` 方法来处理阻塞操作，比如数据库操作。

## 1. 出现问题

在Java21中，虚拟线程已经正式发布，我将http请求的处理全部转移到虚拟线程中，经过测试后，发现一个问题。

目前，应用中有几个耗时较长的查询接口，部署到生产服务器后，接口响应时间在6s左右，客户端每次请求这些接口，都会在5s后直接响应失败，查看相关日志后，发现是服务端主动断开连接。好吧，开始排查...

## 2. 排查问题

查看服务端代码，http相关设置，发现 `idleTimeout` 属性设置为5s，即连接空闲5s后关闭连接。

分析原因：将请求处理代码放到虚拟线程执行后，event loop会认为该连接已空闲，达到指定时间后关闭了连接。


## 3. 修改代码
设置 `idleTimeout` 属性为10s，部署测试。

## 4. 验证
问题解决。
